<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CowSwap 条件交易工具 - 方案1（服务端签名）</title>
<style>
/* 保持原来的样式，略 */
</style>
</head>
<body>
<div class="container">
<h2>CowSwap 条件交易工具</h2>

<div id="walletStatus" class="status info">正在检查Web3钱包...</div>

<div class="form-group">
<label for="sellAmount">卖出数量 (USDT):</label>
<input id="sellAmount" type="number" value="6000" step="0.01">
</div>

<div class="form-group">
<label for="minBuyAmount">最低期望获得 (USDC):</label>
<input id="minBuyAmount" type="number" value="6004" step="0.01">
</div>

<div class="form-group">
<label for="refreshInterval">自动刷新间隔 (秒):</label>
<input id="refreshInterval" type="number" value="30" step="5">
</div>

<button id="getQuoteBtn" disabled>获取CowSwap报价</button>
<button id="startAutoBtn">开始自动刷新</button>
<button id="stopAutoBtn" disabled>停止自动刷新</button>
<button id="submitBtn" disabled>签名并提交当前报价订单</button>

<div id="quoteResult" class="quote-result" style="display:none;">
<h3>报价结果</h3>
<div id="quoteDetails"></div>
<div id="conditionCheck"></div>
</div>

<div id="output">等待获取报价...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
let provider, signer, walletAddress, autoInterval, currentQuote;
const walletStatus = document.getElementById("walletStatus");
const outputEl = document.getElementById("output");
const getQuoteBtn = document.getElementById("getQuoteBtn");
const startAutoBtn = document.getElementById("startAutoBtn");
const stopAutoBtn = document.getElementById("stopAutoBtn");
const submitBtn = document.getElementById("submitBtn");
const quoteResult = document.getElementById("quoteResult");
const quoteDetails = document.getElementById("quoteDetails");
const conditionCheck = document.getElementById("conditionCheck");

async function init(){
  if(typeof window.ethereum==="undefined"){
    walletStatus.textContent="未检测到Web3钱包！"; walletStatus.className="status error"; return;
  }
  try{
    await window.ethereum.request({method:"eth_requestAccounts"});
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    walletAddress = await signer.getAddress();
    walletStatus.textContent="已连接钱包: "+walletAddress.substring(0,8)+"..."; walletStatus.className="status success";
    getQuoteBtn.disabled=false;
  }catch(err){
    walletStatus.textContent="钱包连接失败："+err.message; walletStatus.className="status error";
  }
}

async function getQuote(){
  const sellAmount=parseFloat(document.getElementById("sellAmount").value);
  const minBuyAmount=parseFloat(document.getElementById("minBuyAmount").value);
  outputEl.textContent="正在获取CowSwap报价..."; getQuoteBtn.disabled=true;
  try{
    const sellToken="0xdAC17F958D2ee523a2206206994597c13d831ec7";
    const buyToken="0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48";
    const sellAmountWei=ethers.utils.parseUnits(sellAmount.toString(),6).toString();
    const res=await fetch("https://api.cow.fi/mainnet/api/v1/quote",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({sellToken,buyToken,sellAmountBeforeFee:sellAmountWei,kind:"sell",from:walletAddress})
    });
    if(!res.ok){ const t=await res.text(); outputEl.textContent="获取报价失败: "+res.status+" "+t; return; }
    const data=await res.json(); currentQuote=data.quote;
    const buyAmount=ethers.utils.formatUnits(currentQuote.buyAmount,6);
    quoteDetails.innerHTML=`<p>卖出: ${sellAmount} USDT</p><p>可获得: ${buyAmount} USDC</p>`;
    if(parseFloat(buyAmount)>=minBuyAmount){ conditionCheck.className="condition-met"; conditionCheck.textContent=`✅ 条件满足: ${buyAmount} ≥ ${minBuyAmount}`; submitBtn.disabled=false;
    }else{ conditionCheck.className="condition-not-met"; conditionCheck.textContent=`❌ 条件未满足: ${buyAmount} < ${minBuyAmount}`; submitBtn.disabled=true; }
    quoteResult.style.display="block"; outputEl.textContent=`最新报价: ${buyAmount} USDC`;
  }catch(err){ outputEl.textContent="报价错误: "+err.message; }finally{ getQuoteBtn.disabled=false; }
}

// ⚡ 核心改动：提交订单调用服务端签名接口
async function submitOrder(){
  if(!currentQuote){ outputEl.textContent="没有可用报价，请先获取报价"; return; }
  try{
    outputEl.textContent="请求服务端生成签名...";
    const orderPayload={
      sellToken: currentQuote.sellToken,
      buyToken: currentQuote.buyToken,
      sellAmount: currentQuote.sellAmount,
      buyAmount: currentQuote.buyAmount,
      validTo: Math.floor(Date.now()/1000)+180*60,
      receiver: walletAddress
    };
    // 假设服务端接口 /generate-signature 返回 { signedOrder, signature }
    const resp=await fetch("https://你的服务端地址/generate-signature",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(orderPayload)
    });
    const {signedOrder, signature}=await resp.json();
    outputEl.textContent="提交订单...";
    const res=await fetch("https://api.cow.fi/mainnet/api/v1/orders",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({order:signedOrder,signature,from:walletAddress})
    });
    const data=await res.json();
    if(res.ok){ outputEl.textContent=`订单提交成功! 订单UID: ${data}\n有效期至: ${new Date(orderPayload.validTo*1000).toLocaleString()}`; }
    else{ outputEl.textContent="订单提交失败: "+JSON.stringify(data,null,2); }
  }catch(err){ outputEl.textContent="签名或提交订单错误: "+err.message; }
}

function startAutoQuote(){ const interval=parseInt(document.getElementById("refreshInterval").value,10); if(autoInterval) clearInterval(autoInterval); getQuote(); autoInterval=setInterval(getQuote,interval*1000); startAutoBtn.disabled=true; stopAutoBtn.disabled=false; outputEl.textContent=`已开始自动刷新报价，每${interval}秒更新一次`; }
function stopAutoQuote(){ if(autoInterval) clearInterval(autoInterval); startAutoBtn.disabled=false; stopAutoBtn.disabled=true; outputEl.textContent="已停止自动刷新。"; }

document.addEventListener("DOMContentLoaded",init);
getQuoteBtn.addEventListener("click",getQuote);
startAutoBtn.addEventListener("click",startAutoQuote);
stopAutoBtn.addEventListener("click",stopAutoQuote);
submitBtn.addEventListener("click",submitOrder);
</script>
</body>
</html>
