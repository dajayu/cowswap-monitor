<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CowSwap 报价监控 + WalletConnect v2</title>
  <style>
    body{font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; max-width:900px;margin:20px auto;padding:20px;}
    h1{font-size:20px;}
    .card{border:1px solid #e6e6e6;padding:16px;border-radius:8px;margin-bottom:12px;}
    button{padding:8px 12px;border-radius:6px;border:0;background:#0b74de;color:white;cursor:pointer;}
    button.secondary{background:#666;}
    pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow:auto;}
    .green{color:green;}
    .red{color:#c0392b;}
  </style>
</head>
<body>
  <h1>CowSwap 报价监控（WalletConnect v2）</h1>

  <div class="card">
    <div><strong>配置</strong></div>
    <label>轮询间隔（秒）: <input id="intervalSec" type="number" value="5" style="width:80px"/></label>
    <div style="margin-top:8px">接收地址 (receiver)： <input id="receiver" placeholder="0x..." style="width:60%"/></div>
    <div style="margin-top:8px">WalletConnect ProjectId: <input id="wcProjectId" value="你的ProjectId" style="width:60%"/></div>
  </div>

  <div class="card">
    <div><strong>状态</strong></div>
    <div>最新报价 (buyAmountAfterFee): <span id="latestBuy">-</span></div>
    <div>满足阈值: <span id="thresholdMet">否</span></div>
    <div>上次检查: <span id="lastChecked">-</span></div>
  </div>

  <div class="card">
    <button id="connectBtn">连接 Wallet（扫码）</button>
    <button id="sendBtn" class="secondary" disabled>满足条件时推送交易</button>
  </div>

  <div class="card">
    <div><strong>调试 / 日志</strong></div>
    <pre id="log" style="height:220px;">初始化...</pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script type="module">
    import { Web3Modal } from "https://cdn.jsdelivr.net/npm/@web3modal/html@2.10.2/dist/index.min.js";

    const USDC = { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6 };
    const USDT = { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 };
    const SELL_AMOUNT_USDC = 5000;
    const TARGET_BUY_USDT = 5002;

    const logEl = document.getElementById('log');
    const latestBuyEl = document.getElementById('latestBuy');
    const thresholdMetEl = document.getElementById('thresholdMet');
    const lastCheckedEl = document.getElementById('lastChecked');
    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');

    let provider = null;
    let signer = null;
    let pollTimer = null;
    let latestQuote = null;

    function log(msg){
      const t = new Date().toLocaleString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    async function getCowQuote(token, amount, receiver) {
      const sellAmountWei = BigInt(Math.floor(amount * 1e6)).toString();
      const body = {
        sellToken: token.address,
        buyToken: USDT.address,
        sellAmountBeforeFee: sellAmountWei,
        kind: "sell",
        from: receiver
      };
      try {
        const res = await fetch('https://api.cow.fi/mainnet/api/v1/quote', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
        });
        if (!res.ok) return {error: `CoW API错误: ${res.status}`};
        const data = await res.json();
        if (data.quote && data.quote.buyAmount) return {price: Number(data.quote.buyAmount)/1e6, tx: data.quote.tx};
        return {error: data.description || 'CoW Swap报价失败'};
      } catch(e){
        return {error: e.message || '网络请求失败'};
      }
    }

    async function checkLoop(){
      const interval = Math.max(1, parseInt(document.getElementById('intervalSec').value || '5')) * 1000;
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async ()=>{
        const receiver = document.getElementById('receiver').value.trim();
        if(!/^0x[a-fA-F0-9]{40}$/.test(receiver)){ log('请填写有效的接收地址'); return; }
        lastCheckedEl.textContent = new Date().toLocaleString();
        const quote = await getCowQuote(USDC, SELL_AMOUNT_USDC, receiver);
        if(quote.error){
          latestBuyEl.textContent='-'; thresholdMetEl.textContent='否'; sendBtn.disabled=true;
          log('获取报价失败: ' + quote.error);
          return;
        }
        latestBuyEl.textContent = quote.price;
        log(`报价: 卖 ${SELL_AMOUNT_USDC} USDC -> 预计获得 ${quote.price} USDT`);
        if(quote.price >= TARGET_BUY_USDT){
          thresholdMetEl.textContent='是'; thresholdMetEl.className='green'; sendBtn.disabled=false;
        } else {
          thresholdMetEl.textContent='否'; thresholdMetEl.className='red'; sendBtn.disabled=true;
        }
        latestQuote = quote;
      }, interval);
    }

    connectBtn.addEventListener('click', async () => {
      try{
        const projectId = document.getElementById('wcProjectId').value.trim();
        if(!projectId){ log('请填写 WalletConnect ProjectId'); return; }

        const web3Modal = new Web3Modal({ projectId, themeMode: "light" });
        provider = await web3Modal.connect();
        signer = new ethers.providers.Web3Provider(provider).getSigner();
        const addr = await signer.getAddress();
        log('已连接钱包: ' + addr);
        connectBtn.textContent = '已连接: ' + addr.slice(0,6)+'...'+addr.slice(-4);
        connectBtn.disabled = true;
        sendBtn.disabled = !latestQuote;
      } catch(err){
        log('连接钱包失败: ' + err);
      }
    });

    sendBtn.addEventListener('click', async ()=>{
      try{
        if(!latestQuote){ log('没有最新报价'); return; }
        if(!signer){ log('钱包未连接'); return; }
        const txObj = latestQuote.tx;
        if(!txObj || !txObj.to || !txObj.data){ log('报价无有效交易数据'); console.log(latestQuote); return; }
        let value = txObj.value || '0';
        if(/^[0-9]+$/.test(value)){ value = '0x'+BigInt(value).toString(16); }
        const tx = { to: txObj.to, data: txObj.data, value };
        log('准备发送交易，请在钱包确认...');
        const sent = await signer.sendTransaction(tx);
        log('交易已发送，txHash: ' + sent.hash);
      } catch(err){
        log('发送交易失败: ' + err);
      }
    });

    checkLoop();
  </script>
</body>
</html>
