<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CowSwap Intent Order Demo (Fixed)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
    }
    .container {
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #3498db;
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #output {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
      display: none;
    }
    .error {
      background-color: #ffecec;
      color: #e74c3c;
      border: 1px solid #f5b7b1;
    }
    .success {
      background-color: #e7f6ed;
      color: #27ae60;
      border: 1px solid #a3e4bc;
    }
    .warning {
      background-color: #fef5e7;
      color: #f39c12;
      border: 1px solid #fad7a0;
    }
    .info {
      background-color: #e7f2fa;
      color: #3498db;
      border: 1px solid #aed6f1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>CowSwap Intent Order Demo</h2>
    
    <div id="walletStatus" class="status info">
      Checking for Web3 wallet...
    </div>
    
    <div class="form-group">
      <label for="sellToken">Sell Token (WETH address):</label>
      <input id="sellToken" value="0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2">
    </div>
    
    <div class="form-group">
      <label for="buyToken">Buy Token (USDT address):</label>
      <input id="buyToken" value="0xdAC17F958D2ee523a2206206994597C13D831ec7">
    </div>
    
    <div class="form-group">
      <label for="sellAmount">Sell Amount (ETH):</label>
      <input id="sellAmount" value="1.0">
    </div>
    
    <div class="form-group">
      <label for="buyAmount">Buy Amount (USDT):</label>
      <input id="buyAmount" value="3502">
    </div>
    
    <button id="submitBtn" disabled>Sign & Submit Order</button>
    
    <div id="output">Waiting for wallet connection...</div>
  </div>

  <!-- 使用正确的 ethers.js UMD 版本 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <script>
    const apiBase = "https://api.cow.fi/mainnet/api/v1";
    const outputEl = document.getElementById("output");
    const submitBtn = document.getElementById("submitBtn");
    const walletStatus = document.getElementById("walletStatus");
    
    // 初始化函数
    async function init() {
      walletStatus.style.display = 'block';
      
      // 检查是否安装了以太坊钱包
      if (typeof window.ethereum === 'undefined') {
        showError("Web3 wallet not found. Please install MetaMask or another Web3 wallet!");
        return;
      }
      
      // 检查是否是正确的以太坊提供者
      if (!window.ethereum.isMetaMask && !window.ethereum.isConnected) {
        showError("Compatible Web3 wallet not detected.");
        return;
      }
      
      walletStatus.textContent = "Web3 wallet detected. Connecting...";
      walletStatus.className = "status info";
      
      try {
        // 请求账户访问
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // 创建 ethers 提供者
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const walletAddress = await signer.getAddress();
        
        walletStatus.textContent = "Connected: " + walletAddress.substring(0, 8) + "...";
        walletStatus.className = "status success";
        outputEl.textContent = "Wallet connected successfully. Ready to submit orders.";
        submitBtn.disabled = false;
        
      } catch (err) {
        showError("Wallet connection failed: " + err.message);
      }
    }
    
    // 显示错误信息
    function showError(message) {
      walletStatus.textContent = message;
      walletStatus.className = "status error";
      outputEl.textContent = message;
      submitBtn.disabled = true;
    }
    
    // 提交订单函数
    async function submitOrder() {
      outputEl.textContent = "Preparing order...";
      submitBtn.disabled = true;
      
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const walletAddress = await signer.getAddress();
        
        // 获取输入值
        const sellToken = document.getElementById("sellToken").value;
        const buyToken = document.getElementById("buyToken").value;
        const sellAmountETH = document.getElementById("sellAmount").value;
        const buyAmountUSDT = document.getElementById("buyAmount").value;
        
        // 转换成原子单位
        const sellAmount = ethers.utils.parseUnits(sellAmountETH, 18).toString();
        const buyAmount = ethers.utils.parseUnits(buyAmountUSDT, 6).toString();
        const validTo = Math.floor(Date.now()/1000) + 600; // 10分钟有效期
        
        const unsignedOrder = {
          sellToken,
          buyToken,
          sellAmount,
          buyAmount,
          validTo,
          appData: "0x0000000000000000000000000000000000000000000000000000000000000000",
          feeAmount: "0",
          kind: "sell",
          receiver: walletAddress
        };
        
        outputEl.textContent = "Signing order...";
        
        const domain = {
          name: "CowSwap",
          version: "1.0",
          chainId: 1,
          verifyingContract: "0x9008D19f58AAbD9eD0D60971565AA8510560ab41"
        };
        
        const types = {
          Order: [
            { name: "sellToken", type: "address" },
            { name: "buyToken", type: "address" },
            { name: "receiver", type: "address" },
            { name: "sellAmount", type: "uint256" },
            { name: "buyAmount", type: "uint256" },
            { name: "validTo", type: "uint256" },
            { name: "appData", type: "bytes32" },
            { name: "feeAmount", type: "uint256" },
            { name: "kind", type: "string" }
          ]
        };
        
        const message = unsignedOrder;
        
        // 使用 ethers 进行签名
        outputEl.textContent = "Please confirm the signature in your wallet...";
        const signature = await signer._signTypedData(domain, types, message);
        
        outputEl.textContent = "Submitting order to CowSwap...";
        
        // 提交订单到 CowSwap API
        const res = await fetch(`${apiBase}/orders`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({order: unsignedOrder, signature})
        });
        
        const data = await res.json();
        outputEl.textContent = "Order submitted successfully!\n" + JSON.stringify(data, null, 2);
        submitBtn.disabled = false;
        
      } catch(err) {
        showError("Error: " + err.message);
        submitBtn.disabled = false;
      }
    }
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', init);
    document.getElementById("submitBtn").addEventListener("click", submitOrder);
  </script>
</body>
</html>
