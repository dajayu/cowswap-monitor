<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CowSwap Minimal Test Order</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding:20px; max-width:600px; margin:auto; background:#f5f7fa; color:#333; }
.container { background:white; border-radius:12px; padding:25px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
h2 { text-align:center; margin-bottom:20px; }
input, button { width:100%; padding:10px; margin-top:10px; font-size:16px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
button { background:#3498db; color:white; border:none; cursor:pointer; }
button:disabled { background:#95a5a6; cursor:not-allowed; }
#output { background:#f8f9fa; padding:15px; border-radius:6px; margin-top:15px; font-family:monospace; white-space:pre-wrap; }
#orderUidDisplay { margin-top:15px; font-size:20px; font-weight:bold; }
.status { padding:10px; border-radius:6px; margin-bottom:10px; text-align:center; display:none; }
.success { background:#e7f6ed; color:#27ae60; border:1px solid #a3e4bc; }
.error { background:#ffecec; color:#e74c3c; border:1px solid #f5b7b1; }
.info { background:#e7f2fa; color:#3498db; border:1px solid #aed6f1; }
</style>
</head>
<body>
<div class="container">
  <h2>CowSwap Minimal Test Order</h2>
  <div id="walletStatus" class="status info">Checking wallet...</div>

  <input id="sellToken" value="0xdAC17F958D2ee523a2206206994597C13D831ec7" placeholder="Sell Token (USDT)">
  <input id="buyToken" value="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" placeholder="Buy Token (USDC)">
  <input id="sellAmount" value="3500" placeholder="Sell Amount">
  <input id="buyAmount" value="3500" placeholder="Buy Amount">
  <button id="submitBtn" disabled>Sign & Submit Order</button>

  <div id="output">Waiting for wallet...</div>
  <div id="orderUidDisplay"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const apiBase = "https://api.cow.fi/mainnet/api/v1";
const walletStatus = document.getElementById("walletStatus");
const submitBtn = document.getElementById("submitBtn");
const outputEl = document.getElementById("output");

async function init() {
  walletStatus.style.display = 'block';
  if(!window.ethereum){ 
    showError("Web3 wallet not found!");
    return;
  }
  try {
    await window.ethereum.request({method:'eth_requestAccounts'});
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const addr = await signer.getAddress();
    walletStatus.textContent = "Connected: " + addr.substring(0,8) + "...";
    walletStatus.className = "status success";
    outputEl.textContent = "Wallet connected.";
    submitBtn.disabled = false;
  } catch(err) {
    showError("Wallet connection failed: " + err.message);
  }
}

function showError(msg){
  walletStatus.textContent = msg;
  walletStatus.className = "status error";
  outputEl.textContent = msg;
  submitBtn.disabled = true;
}

async function submitOrder(){
  submitBtn.disabled = true;
  outputEl.textContent = "Preparing order...";
  document.getElementById("orderUidDisplay").textContent = "";

  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const walletAddress = await signer.getAddress();

    const sellToken = document.getElementById("sellToken").value.trim();
    const buyToken = document.getElementById("buyToken").value.trim();
    const sellAmount = ethers.BigNumber.from(ethers.utils.parseUnits(document.getElementById("sellAmount").value.trim(),6).toString());
    const buyAmount = ethers.BigNumber.from(ethers.utils.parseUnits(document.getElementById("buyAmount").value.trim(),6).toString());
    const validTo = Math.floor(Date.now()/1000 + 600); // uint32

    const unsignedOrder = {
      sellToken,
      buyToken,
      receiver: walletAddress,
      sellAmount,
      buyAmount,
      validTo,
      appData: "0x40fc3752068beb68cbd94040fa900592994011f3c54211773c50fc6e96fe5696",
      feeAmount: "0",
      kind: "sell",
      partiallyFillable: false,
      sellTokenBalance: "erc20",
      buyTokenBalance: "erc20"
    };

    const domain = {
      name: "Gnosis Protocol",
      version: "v2",
      chainId: 1,
      verifyingContract: "0x9008d19f58aabd9ed0d60971565aa8510560ab41"
    };

    const types = {
      Order: [
        {name:"sellToken", type:"address"},
        {name:"buyToken", type:"address"},
        {name:"receiver", type:"address"},
        {name:"sellAmount", type:"uint256"},
        {name:"buyAmount", type:"uint256"},
        {name:"validTo", type:"uint32"},
        {name:"appData", type:"bytes32"},
        {name:"feeAmount", type:"uint256"},
        {name:"kind", type:"string"},
        {name:"partiallyFillable", type:"bool"},
        {name:"sellTokenBalance", type:"string"},
        {name:"buyTokenBalance", type:"string"}
      ]
    };

    outputEl.textContent = "Please confirm signature in your wallet...";
    const signature = await signer._signTypedData(domain, types, unsignedOrder);

    outputEl.textContent = "Submitting order...";
    const res = await fetch(`${apiBase}/orders`,{
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({order: unsignedOrder, signature})
    });
    const data = await res.json();

    outputEl.textContent = "Order submitted!\n" + JSON.stringify(data, null, 2);
    if(data.orderUid){
      document.getElementById("orderUidDisplay").textContent = "orderUid: " + data.orderUid;
    }

    // 模拟错误，方便调试
    console.log("Simulated error for debugging:", {errorField:"sellTokenBalance", expected:"erc20", got:"erc20 "});

    submitBtn.disabled = false;
  } catch(err){
    showError("Error: "+err.message);
    submitBtn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', init);
submitBtn.addEventListener("click", submitOrder);
</script>
</body>
</html>
