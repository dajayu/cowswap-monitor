<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CowSwap 监控 + WalletConnect v2</title>
    <style>
        /* 样式保持不变，可以沿用之前的样式 */
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .card {
            border: 1px solid #e6e6e6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        button {
            padding: 10px 16px;
            border-radius: 6px;
            border: 0;
            background: #0b74de;
            color: white;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0a60b9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.secondary {
            background: #666;
        }
        pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
            font-size: 13px;
        }
        .green {
            color: green;
        }
        .red {
            color: #c0392b;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        label {
            font-weight: 500;
        }
        .status-item {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <h1>CowSwap 报价监控（WalletConnect v2 半自动，本地 SDK）</h1>

    <div class="card">
        <div><strong>配置</strong></div>
        <label>轮询间隔（秒）: <input id="intervalSec" type="number" value="5" style="width:80px"></label>
        <div style="margin-top:8px">接收地址 (receiver)： <input id="receiver" placeholder="0x..." style="width:60%"></div>
        <div style="margin-top:8px">WalletConnect ProjectId: <input id="wcProjectId" value="a6bb773a95cb2a91e8fd79aba96311f1" placeholder="在 WalletConnect Cloud 获取 ProjectId" style="width:60%"></div>
    </div>

    <div class="card">
        <div><strong>状态</strong></div>
        <div class="status-item">最新报价 (buyAmountAfterFee): <span id="latestBuy">-</span></div>
        <div class="status-item">满足阈值: <span id="thresholdMet">否</span></div>
        <div class="status-item">上次检查: <span id="lastChecked">-</span></div>
    </div>

    <div class="card">
        <button id="connectBtn">连接 Wallet（WalletConnect v2 / 扫码）</button>
        <button id="sendBtn" class="secondary" disabled>满足条件时推送交易到 Wallet</button>
    </div>

    <div class="card">
        <div><strong>调试 / 日志</strong></div>
        <pre id="log">初始化...</pre>
    </div>

    <!-- 引入ethers -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- 引入Web3Modal独立版本 -->
    <script src="https://unpkg.com/@web3modal/standalone@2.10.0/dist/index.js"></script>

    <script>
        // 获取DOM元素
        const logEl = document.getElementById('log');
        const latestBuyEl = document.getElementById('latestBuy');
        const thresholdMetEl = document.getElementById('thresholdMet');
        const lastCheckedEl = document.getElementById('lastChecked');
        const connectBtn = document.getElementById('connectBtn');
        const sendBtn = document.getElementById('sendBtn');

        // 状态变量
        let ethersProvider = null;
        let signer = null;
        let pollTimer = null;
        let isConnected = false;
        let web3Modal = null;

        // 日志函数
        function log(msg) {
            const t = new Date().toLocaleTimeString();
            logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
        }

        // CoW 配置
        const USDC = { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6 };
        const USDT = { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 };
        const SELL_AMOUNT_USDC = 5000;
        const TARGET_BUY_USDT = 5002;

        // 获取CowSwap报价
        async function getCowQuote(token, amount, receiver) {
            const sellAmountWei = BigInt(Math.floor(amount * 1e6)).toString();
            const body = {
                sellToken: token.address,
                buyToken: USDT.address,
                sellAmountBeforeFee: sellAmountWei,
                kind: "sell",
                from: receiver
            };
            
            try {
                const res = await fetch('https://api.cow.fi/mainnet/api/v1/quote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    return {error: `CoW API错误: ${res.status}`};
                }
                
                const data = await res.json();
                if (data.quote && data.quote.buyAmount) {
                    return {
                        price: Number(data.quote.buyAmount) / 1e6,
                        tx: data.quote
                    };
                }
                
                return {error: data.description || 'CoW Swap报价失败'};
            } catch(e) {
                return {error: e.message || '网络请求失败'};
            }
        }

        // 轮询检查报价
        function checkLoop() {
            const interval = Math.max(1, parseInt(document.getElementById('intervalSec').value || '5')) * 1000;
            
            if (pollTimer) {
                clearInterval(pollTimer);
            }
            
            pollTimer = setInterval(async () => {
                const receiver = document.getElementById('receiver').value.replace(/\s+/g, '').trim();
                
                if (!/^0x[a-fA-F0-9]{40}$/.test(receiver)) { 
                    log('请填写有效的接收地址'); 
                    return; 
                }
                
                lastCheckedEl.textContent = new Date().toLocaleTimeString();
                const quote = await getCowQuote(USDC, SELL_AMOUNT_USDC, receiver);
                
                if (quote.error) {
                    latestBuyEl.textContent = '-';
                    thresholdMetEl.textContent = '否';
                    thresholdMetEl.className = 'red';
                    sendBtn.disabled = true;
                    log('获取报价失败: ' + quote.error);
                    return;
                }
                
                latestBuyEl.textContent = quote.price.toFixed(6);
                log(`报价: 卖 ${SELL_AMOUNT_USDC} USDC -> 预计获得 ${quote.price.toFixed(6)} USDT`);
                
                if (quote.price >= TARGET_BUY_USDT) {
                    thresholdMetEl.textContent = '是';
                    thresholdMetEl.className = 'green';
                    sendBtn.disabled = !isConnected;
                } else {
                    thresholdMetEl.textContent = '否';
                    thresholdMetEl.className = 'red';
                    sendBtn.disabled = true;
                }
                
                window.latestQuote = quote;
            }, interval);
        }

        // WalletConnect v2 连接
        connectBtn.addEventListener('click', async () => {
            try {
                const projectId = document.getElementById('wcProjectId').value.trim();
                
                if (!projectId) { 
                    log('请填写 WalletConnect ProjectId'); 
                    return; 
                }
                
                log('正在初始化 Web3Modal...');
                
                // 初始化Web3Modal
                web3Modal = new window.Web3Modal.default({
                    projectId,
                    chains: [1],
                    enableExplorer: true,
                });
                
                // 打开连接模态框
                const provider = await web3Modal.connect();
                
                // 连接成功
                isConnected = true;
                
                // 设置Ethers.js提供者和签名者
                ethersProvider = new ethers.providers.Web3Provider(provider);
                signer = ethersProvider.getSigner();
                const address = await signer.getAddress();
                
                log('已连接钱包: ' + address);
                connectBtn.textContent = '已连接: ' + address.slice(0, 6) + '...' + address.slice(-4);
                connectBtn.disabled = true;
                
                // 如果满足条件，启用发送按钮
                if (window.latestQuote && window.latestQuote.price >= TARGET_BUY_USDT) {
                    sendBtn.disabled = false;
                }
                
                // 监听账户变化
                provider.on('accountsChanged', (accounts) => {
                    log('账户已变更: ' + accounts[0]);
                });
                
                // 监听链变化
                provider.on('chainChanged', (chainId) => {
                    log('网络已变更: ' + parseInt(chainId, 16));
                });
                
                // 监听断开连接
                provider.on('disconnect', (code, reason) => {
                    log('连接已断开: ' + reason);
                    isConnected = false;
                    connectBtn.textContent = '连接 Wallet（WalletConnect v2 / 扫码）';
                    connectBtn.disabled = false;
                    sendBtn.disabled = true;
                });
                
            } catch(err) {
                console.error('连接钱包失败', err);
                log('连接钱包失败: ' + (err.message || err));
            }
        });

        // 发送交易
        sendBtn.addEventListener('click', async () => {
            try {
                if (!window.latestQuote) {
                    log('没有最新报价');
                    return;
                }
                
                if (!signer) {
                    log('钱包未连接');
                    return;
                }
                
                const txObj = window.latestQuote.tx;
                
                if (!txObj || !txObj.to || !txObj.data) { 
                    log('报价无有效交易数据'); 
                    return; 
                }
                
                let value = txObj.value || '0';
                if (/^[0-9]+$/.test(value)) { 
                    value = '0x' + BigInt(value).toString(16); 
                }
                
                const txParams = { 
                    to: txObj.to, 
                    data: txObj.data, 
                    value: value
                };
                
                // 添加gas限制和gas价格（如果提供）
                if (txObj.gas) {
                    txParams.gasLimit = ethers.BigNumber.from(txObj.gas);
                }
                
                if (txObj.gasPrice) {
                    txParams.gasPrice = ethers.BigNumber.from(txObj.gasPrice);
                }
                
                log('准备发送交易，请在钱包确认...');
                const sentTx = await signer.sendTransaction(txParams);
                log('交易已发送，txHash: ' + sentTx.hash);
                
                // 等待交易确认
                const receipt = await sentTx.wait();
                log('交易已确认，区块: ' + receipt.blockNumber);
                
            } catch(err) { 
                log('发送交易失败: ' + (err.message || err)); 
            }
        });

        // 启动轮询
        checkLoop();
        log('CowSwap 监控已启动，开始轮询报价...');
    </script>
</body>
</html>
