<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CowSwap 条件交易工具</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width:800px;margin:0 auto;padding:20px; background:#1a1a1a;color:#e6e6e6;}
.container { background:#2d2d2d; padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3);}
h2 { color:#4cc9f0; text-align:center; margin-bottom:25px;}
.form-group { margin-bottom:20px;}
label { display:block; margin-bottom:8px; font-weight:500;}
input { width:100%; padding:12px; border-radius:6px; border:1px solid #444; background:#3d3d3d; color:#e6e6e6; font-size:16px;}
button { background:linear-gradient(135deg,#4cc9f0,#4361ee); color:white; padding:14px 20px; border:none; border-radius:6px; font-size:16px; font-weight:600; width:100%; cursor:pointer; margin-top:10px; transition:all 0.3s;}
button:hover:not(:disabled){transform:translateY(-2px); box-shadow:0 4px 12px rgba(76,201,240,0.3);}
button:disabled{background:#555; cursor:not-allowed;}
#output {margin-top:20px; padding:15px; background:#3d3d3d; border-radius:6px; font-family:monospace; max-height:300px; overflow-y:auto;}
.quote-result {background:#3d5c4c; padding:15px; border-radius:6px; margin-top:15px;}
.condition-met {background:#2a5e3d; color:#7bffb3; padding:10px; border-radius:6px; margin-top:10px;}
.condition-not-met {background:#5e2a2a; color:#ff7b7b; padding:10px; border-radius:6px; margin-top:10px;}
</style>
</head>
<body>
<div class="container">
<h2>CowSwap 条件交易工具</h2>

<div class="form-group">
<label for="sellAmount">卖出数量 (USDT):</label>
<input id="sellAmount" type="number" value="6000" step="0.01">
</div>

<div class="form-group">
<label for="minBuyAmount">最低期望获得 (USDC):</label>
<input id="minBuyAmount" type="number" value="6004" step="0.01">
</div>

<div class="form-group">
<label for="refreshInterval">自动刷新间隔 (秒):</label>
<input id="refreshInterval" type="number" value="30" step="5">
</div>

<button id="getQuoteBtn" disabled>获取报价</button>
<button id="startAutoBtn">开始自动刷新</button>
<button id="stopAutoBtn" disabled>停止自动刷新</button>
<button id="submitBtn" disabled>签名并提交订单</button>

<div id="quoteResult" class="quote-result" style="display:none;">
<div id="quoteDetails"></div>
<div id="conditionCheck"></div>
</div>

<div id="output">等待获取报价...</div>
</div>

<script type="module">
import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';
import { OrderBookApi, OrderSigningUtils, SupportedChainId, SigningScheme } from 'https://cdn.jsdelivr.net/npm/@cowprotocol/cow-sdk@latest/dist/cow-sdk.esm.min.js';

let provider, signer, walletAddress;
let currentQuote = null;
let autoInterval = null;

const getQuoteBtn = document.getElementById('getQuoteBtn');
const startAutoBtn = document.getElementById('startAutoBtn');
const stopAutoBtn = document.getElementById('stopAutoBtn');
const submitBtn = document.getElementById('submitBtn');
const quoteDetails = document.getElementById('quoteDetails');
const conditionCheck = document.getElementById('conditionCheck');
const outputEl = document.getElementById('output');

async function init() {
  if(!window.ethereum){ outputEl.textContent="未检测到Web3钱包！"; return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();
  try{
    await window.ethereum.request({method:'eth_requestAccounts'});
    walletAddress = await signer.getAddress();
    outputEl.textContent="已连接钱包: "+walletAddress;
    getQuoteBtn.disabled=false;
  }catch(e){ outputEl.textContent="钱包连接失败："+e.message; }
}

async function getQuote(){
  const sellAmount = document.getElementById('sellAmount').value;
  const minBuyAmount = parseFloat(document.getElementById('minBuyAmount').value);
  outputEl.textContent="正在获取报价...";
  getQuoteBtn.disabled=true;
  try{
    const body = {
      sellToken:"0xdAC17F958D2ee523a2206206994597c13d831ec7",
      buyToken:"0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
      sellAmountBeforeFee: ethers.utils.parseUnits(sellAmount,6).toString(),
      kind:'sell',
      from: walletAddress
    };
    const res = await fetch('https://api.cow.fi/mainnet/api/v1/quote',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    if(!res.ok){ const text=await res.text(); outputEl.textContent="报价获取失败: "+res.status+" "+text; return; }
    const data = await res.json();
    currentQuote = data.quote;
    const buyAmount = parseFloat(ethers.utils.formatUnits(currentQuote.buyAmount,6));
    quoteDetails.innerHTML=`卖出: ${sellAmount} USDT<br>可获得: ${buyAmount} USDC`;
    if(buyAmount>=minBuyAmount){
      conditionCheck.className='condition-met';
      conditionCheck.textContent=`✅ 条件满足: ${buyAmount} ≥ ${minBuyAmount}`;
      submitBtn.disabled=false;
    }else{
      conditionCheck.className='condition-not-met';
      conditionCheck.textContent=`❌ 条件未满足: ${buyAmount} < ${minBuyAmount}`;
      submitBtn.disabled=true;
    }
    quoteDetails.parentElement.style.display='block';
    outputEl.textContent=`最新报价: ${buyAmount} USDC`;
  }catch(e){ outputEl.textContent="报价错误: "+e.message; }
  finally{ getQuoteBtn.disabled=false; }
}

async function submitOrder(){
  if(!currentQuote){ outputEl.textContent="没有可用报价，请先获取报价"; return; }
  outputEl.textContent="请在钱包中签名订单...";
  const order = {
    sellToken: currentQuote.sellToken,
    buyToken: currentQuote.buyToken,
    receiver: walletAddress,
    sellAmount: currentQuote.sellAmount,
    buyAmount: currentQuote.buyAmount,
    validTo: Math.floor(Date.now()/1000)+180*60,
    appData: currentQuote.appData || '0x'+ '0'.repeat(64),
    feeAmount: currentQuote.feeAmount || '0',
    kind:'sell',
    partiallyFillable:false
  };
  try{
    const signedOrder = await OrderSigningUtils.signOrder({
      order,
      signer,
      signingScheme: SigningScheme.EIP712
    });
    const api = new OrderBookApi({ chainId: SupportedChainId.MAINNET });
    const orderId = await api.sendOrder({ ...signedOrder, from: walletAddress });
    outputEl.textContent=`订单提交成功! UID: ${orderId}`;
  }catch(e){ outputEl.textContent="签名或提交订单错误: "+e.message; }
}

function startAutoQuote(){
  const interval = parseInt(document.getElementById('refreshInterval').value,10);
  if(autoInterval) clearInterval(autoInterval);
  getQuote();
  autoInterval = setInterval(getQuote, interval*1000);
  startAutoBtn.disabled=true; stopAutoBtn.disabled=false;
  outputEl.textContent=`已开始自动刷新，每${interval}秒`;
}

function stopAutoQuote(){
  if(autoInterval) clearInterval(autoInterval); autoInterval=null;
  startAutoBtn.disabled=false; stopAutoBtn.disabled=true;
  outputEl.textContent="已停止自动刷新";
}

document.addEventListener('DOMContentLoaded',init);
getQuoteBtn.addEventListener('click',getQuote);
submitBtn.addEventListener('click',submitOrder);
startAutoBtn.addEventListener('click',startAutoQuote);
stopAutoBtn.addEventListener('click',stopAutoQuote);
</script>
</body>
</html>
