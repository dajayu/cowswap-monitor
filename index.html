<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CowSwap 监控 + 直接钱包连接</title>
    <style>
        body {
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .card {
            border: 1px solid #e6e6e6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        button {
            padding: 10px 16px;
            border-radius: 6px;
            border: 0;
            background: #0b74de;
            color: white;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0a60b9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.secondary {
            background: #666;
        }
        button.success {
            background: #27ae60;
        }
        pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
            font-size: 13px;
        }
        .green {
            color: green;
        }
        .red {
            color: #c0392b;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        label {
            font-weight: 500;
        }
        .status-item {
            margin: 8px 0;
        }
        .wallet-status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .connected {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
        }
        .disconnected {
            background: #ffebee;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
    <h1>CowSwap 报价监控（直接钱包连接）</h1>

    <div class="card">
        <div><strong>配置</strong></div>
        <label>轮询间隔（秒）: <input id="intervalSec" type="number" value="5" style="width:80px"></label>
        <div style="margin-top:8px">接收地址 (receiver)： <input id="receiver" placeholder="0x..." style="width:60%"></div>
    </div>

    <div class="card">
        <div><strong>钱包状态</strong></div>
        <div id="walletStatus" class="wallet-status disconnected">未连接钱包</div>
        <button id="connectBtn">连接钱包（MetaMask等）</button>
        <button id="disconnectBtn" class="secondary" disabled>断开连接</button>
    </div>

    <div class="card">
        <div><strong>状态</strong></div>
        <div class="status-item">最新报价 (buyAmountAfterFee): <span id="latestBuy">-</span></div>
        <div class="status-item">满足阈值: <span id="thresholdMet">否</span></div>
        <div class="status-item">上次检查: <span id="lastChecked">-</span></div>
    </div>

    <div class="card">
        <button id="sendBtn" class="secondary" disabled>满足条件时推送交易到钱包</button>
    </div>

    <div class="card">
        <div><strong>调试 / 日志</strong></div>
        <pre id="log">初始化...</pre>
    </div>

    <!-- 引入ethers -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // 获取DOM元素
        const logEl = document.getElementById('log');
        const latestBuyEl = document.getElementById('latestBuy');
        const thresholdMetEl = document.getElementById('thresholdMet');
        const lastCheckedEl = document.getElementById('lastChecked');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const walletStatus = document.getElementById('walletStatus');

        // 状态变量
        let ethersProvider = null;
        let signer = null;
        let pollTimer = null;
        let isConnected = false;

        // 日志函数
        function log(msg) {
            const t = new Date().toLocaleTimeString();
            logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
        }

        // 更新钱包状态显示
        function updateWalletStatus(connected, address = '') {
            isConnected = connected;
            if (connected) {
                walletStatus.textContent = `已连接: ${address}`;
                walletStatus.className = 'wallet-status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                walletStatus.textContent = '未连接钱包';
                walletStatus.className = 'wallet-status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            }
        }

        // CoW 配置
        const USDC = { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6 };
        const USDT = { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 };
        const SELL_AMOUNT_USDC = 5000;
        const TARGET_BUY_USDT = 5002;

        // 获取CowSwap报价
        async function getCowQuote(token, amount, receiver) {
            const sellAmountWei = BigInt(Math.floor(amount * 1e6)).toString();
            const body = {
                sellToken: token.address,
                buyToken: USDT.address,
                sellAmountBeforeFee: sellAmountWei,
                kind: "sell",
                from: receiver
            };
            
            try {
                const res = await fetch('https://api.cow.fi/mainnet/api/v1/quote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    return {error: `CoW API错误: ${res.status}`};
                }
                
                const data = await res.json();
                if (data.quote && data.quote.buyAmount) {
                    return {
                        price: Number(data.quote.buyAmount) / 1e6,
                        tx: data.quote
                    };
                }
                
                return {error: data.description || 'CoW Swap报价失败'};
            } catch(e) {
                return {error: e.message || '网络请求失败'};
            }
        }

        // 轮询检查报价
        function checkLoop() {
            const interval = Math.max(1, parseInt(document.getElementById('intervalSec').value || '5')) * 1000;
            
            if (pollTimer) {
                clearInterval(pollTimer);
            }
            
            pollTimer = setInterval(async () => {
                const receiver = document.getElementById('receiver').value.replace(/\s+/g, '').trim();
                
                if (!/^0x[a-fA-F0-9]{40}$/.test(receiver)) { 
                    log('请填写有效的接收地址'); 
                    return; 
                }
                
                lastCheckedEl.textContent = new Date().toLocaleTimeString();
                const quote = await getCowQuote(USDC, SELL_AMOUNT_USDC, receiver);
                
                if (quote.error) {
                    latestBuyEl.textContent = '-';
                    thresholdMetEl.textContent = '否';
                    thresholdMetEl.className = 'red';
                    sendBtn.disabled = true;
                    log('获取报价失败: ' + quote.error);
                    return;
                }
                
                latestBuyEl.textContent = quote.price.toFixed(6);
                log(`报价: 卖 ${SELL_AMOUNT_USDC} USDC -> 预计获得 ${quote.price.toFixed(6)} USDT`);
                
                if (quote.price >= TARGET_BUY_USDT) {
                    thresholdMetEl.textContent = '是';
                    thresholdMetEl.className = 'green';
                    sendBtn.disabled = !isConnected;
                } else {
                    thresholdMetEl.textContent = '否';
                    thresholdMetEl.className = 'red';
                    sendBtn.disabled = true;
                }
                
                window.latestQuote = quote;
            }, interval);
        }

        // 连接钱包
        connectBtn.addEventListener('click', async () => {
            try {
                // 检查是否安装了以太坊钱包
                if (typeof window.ethereum === 'undefined') {
                    log('未检测到以太坊钱包。请安装MetaMask或其他兼容钱包。');
                    return;
                }
                
                log('请求连接钱包...');
                
                // 请求账户访问权限
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // 创建Ethers提供者和签名者
                ethersProvider = new ethers.providers.Web3Provider(window.ethereum);
                signer = ethersProvider.getSigner();
                const address = await signer.getAddress();
                
                log('已连接钱包: ' + address);
                updateWalletStatus(true, address);
                
                // 如果满足条件，启用发送按钮
                if (window.latestQuote && window.latestQuote.price >= TARGET_BUY_USDT) {
                    sendBtn.disabled = false;
                }
                
                // 监听账户变化
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        log('钱包已断开连接');
                        updateWalletStatus(false);
                    } else {
                        log('账户已变更: ' + accounts[0]);
                        signer = ethersProvider.getSigner();
                        updateWalletStatus(true, accounts[0]);
                    }
                });
                
                // 监听链变化
                window.ethereum.on('chainChanged', (chainId) => {
                    log('网络已变更: ' + parseInt(chainId, 16));
                    // 重新初始化提供者
                    ethersProvider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = ethersProvider.getSigner();
                });
                
            } catch(err) {
                console.error('连接钱包失败', err);
                log('连接钱包失败: ' + (err.message || err));
            }
        });

        // 断开钱包连接
        disconnectBtn.addEventListener('click', () => {
            // 对于大多数浏览器钱包，我们不能真正"断开"连接
            // 但可以重置我们的状态
            updateWalletStatus(false);
            log('已断开钱包连接');
        });

        // 发送交易
        sendBtn.addEventListener('click', async () => {
            try {
                if (!window.latestQuote) {
                    log('没有最新报价');
                    return;
                }
                
                if (!signer) {
                    log('钱包未连接');
                    return;
                }
                
                const txObj = window.latestQuote.tx;
                
                if (!txObj || !txObj.to || !txObj.data) { 
                    log('报价无有效交易数据'); 
                    return; 
                }
                
                let value = txObj.value || '0';
                if (/^[0-9]+$/.test(value)) { 
                    value = '0x' + BigInt(value).toString(16); 
                }
                
                const txParams = { 
                    to: txObj.to, 
                    data: txObj.data, 
                    value: value
                };
                
                // 添加gas限制和gas价格（如果提供）
                if (txObj.gas) {
                    txParams.gasLimit = ethers.BigNumber.from(txObj.gas);
                }
                
                if (txObj.gasPrice) {
                    txParams.gasPrice = ethers.BigNumber.from(txObj.gasPrice);
                }
                
                log('准备发送交易，请在钱包确认...');
                const sentTx = await signer.sendTransaction(txParams);
                log('交易已发送，txHash: ' + sentTx.hash);
                
                // 等待交易确认
                const receipt = await sentTx.wait();
                log('交易已确认，区块: ' + receipt.blockNumber);
                
            } catch(err) { 
                log('发送交易失败: ' + (err.message || err)); 
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已经连接了钱包
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            // 自动连接已授权的钱包
                            ethersProvider = new ethers.providers.Web3Provider(window.ethereum);
                            signer = ethersProvider.getSigner();
                            signer.getAddress().then(address => {
                                log('检测到已连接的钱包: ' + address);
                                updateWalletStatus(true, address);
                            });
                        }
                    });
            }
            
            // 启动轮询
            checkLoop();
            log('CowSwap 监控已启动，开始轮询报价...');
        });
    </script>
</body>
</html>
