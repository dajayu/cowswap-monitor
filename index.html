<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CowSwap 条件交易工具</title>
  <style>
    /* 样式保持不变 */
  </style>
</head>
<body>
  <div class="container">
    <h2>CowSwap 条件交易工具</h2>

    <div id="walletStatus" class="status info">正在检查Web3钱包...</div>

    <div class="form-group">
      <label for="sellAmount">卖出数量 (USDT):</label>
      <input id="sellAmount" type="number" value="6000" step="0.01">
    </div>

    <div class="form-group">
      <label for="minBuyAmount">最低期望获得 (USDC):</label>
      <input id="minBuyAmount" type="number" value="6004" step="0.01">
    </div>

    <div class="form-group">
      <label for="refreshInterval">自动刷新间隔 (秒):</label>
      <input id="refreshInterval" type="number" value="30" step="5">
    </div>

    <button id="getQuoteBtn">获取CowSwap报价</button>
    <button id="startAutoBtn">开始自动刷新</button>
    <button id="stopAutoBtn" disabled>停止自动刷新</button>

    <div id="quoteResult" class="quote-result" style="display:none;">
      <h3>报价结果</h3>
      <div id="quoteDetails"></div>
      <div id="conditionCheck"></div>
    </div>

    <div id="output">等待获取报价...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const apiBase = "https://api.cow.fi/mainnet/api/v1/quote";
    const orderBookApi = "https://api.cow.fi/mainnet/api/v1/order";
    const outputEl = document.getElementById("output");
    const getQuoteBtn = document.getElementById("getQuoteBtn");
    const startAutoBtn = document.getElementById("startAutoBtn");
    const stopAutoBtn = document.getElementById("stopAutoBtn");
    const quoteResult = document.getElementById("quoteResult");
    const quoteDetails = document.getElementById("quoteDetails");
    const conditionCheck = document.getElementById("conditionCheck");

    let autoInterval = null;
    let currentQuote = null;

    async function getCowQuote(token, amount) {
      const sellAmountWei = BigInt(Math.floor(amount * 1e6)).toString(); // 使用6位小数
      const body = {
        sellToken: token.address,
        buyToken: "0xdAC17F958D2ee523a2206206994597c13d831ec7", // USDC 地址
        sellAmountBeforeFee: sellAmountWei,
        kind: "sell",
        from: "0x000000000000000000000000000000000000dead"
      };
      try {
        const res = await fetch(apiBase, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const text = await res.text();
          return {error: `CoW API错误: ${res.status} - ${text}`};
        }
        const data = await res.json();
        if (data.quote && data.quote.buyAmount) {
          return {priceRaw: data.quote.buyAmount, raw: data.quote};
        }
        return {error: data.description || "CoW Swap报价失败"};
      } catch(e) {
        return {error: e.message || "网络请求失败"};
      }
    }

    async function getQuote() {
      const sellAmount = parseFloat(document.getElementById("sellAmount").value);
      const minBuyAmount = parseFloat(document.getElementById("minBuyAmount").value);
      outputEl.textContent = "正在获取CowSwap报价...";
      const token = { address: "0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48" }; // USDT 地址
      const result = await getCowQuote(token, sellAmount);
      if (result.priceRaw) {
        const buyAmount = ethers.utils.formatUnits(result.priceRaw, 6); // 格式化为6位小数
        currentQuote = result.raw;
        quoteDetails.innerHTML = `<p>卖出: ${sellAmount} USDT</p>
                                  <p>可获得: ${buyAmount} USDC</p>`;
        if (parseFloat(buyAmount) >= minBuyAmount) {
          conditionCheck.className = "condition-met";
          conditionCheck.textContent = `✅ 条件满足: ${buyAmount} ≥ ${minBuyAmount}`;
          await signAndSubmitOrder(sellAmount, buyAmount);
        } else {
          conditionCheck.className = "condition-not-met";
          conditionCheck.textContent = `❌ 条件未满足: ${buyAmount} < ${minBuyAmount}`;
        }
        quoteResult.style.display = "block";
        outputEl.textContent = `最新报价: ${buyAmount} USDC`;
      } else {
        outputEl.textContent = "报价错误: " + result.error;
      }
    }

    async function signAndSubmitOrder(sellAmount, buyAmount) {
      const order = createOrder(sellAmount, buyAmount);
      const signedOrder = await signOrder(order);
      await submitOrder(signedOrder);
    }

    function createOrder(sellAmount, buyAmount) {
      return {
        sellToken: "0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", // USDT 地址
        buyToken: "0xdAC17F958D2ee523a2206206994597c13d831ec7", // USDC 地址
        sellAmount: (sellAmount * 1e6).toString(),
        buyAmount: (buyAmount * 1e6).toString(),
        receiver: "0x000000000000000000000000000000000000dead", // 接收地址
        validTo: Math.floor(Date.now() / 1000) + 180 * 60, // 180分钟有效期
        nonce: Date.now(),
        appData: "0x", // 可选，附加数据
        feeAmount: "0", // 可选，费用金额
        signature: "" // 待签名
      };
    }

    async function signOrder(order) {
      const domain = {
        name: "CoW Protocol",
        version: "1",
        chainId: 1, // 主网
        verifyingContract: "ORDER_BOOK_CONTRACT_ADDRESS"
      };
      const types = {
        Order: [
          { name: "sellToken", type: "address" },
          { name: "buyToken", type: "address" },
          { name: "sellAmount", type: "uint256" },
          { name: "buyAmount", type: "uint256" },
          { name: "receiver", type: "address" },
          { name: "validTo", type: "uint256" },
          { name: "nonce", type: "uint256" },
          { name: "appData", type: "bytes" },
          { name: "feeAmount", type: "uint256" }
        ]
      };
      const message = {
        sellToken: order.sellToken,
        buyToken: order.buyToken,
        sellAmount: order.sellAmount,
        buyAmount: order.buyAmount,
        receiver: order.receiver,
        validTo: order.validTo,
        nonce: order.nonce,
        appData: order.appData,
        feeAmount: order.feeAmount
      };
      const signer = new ethers.Wallet("USER_PRIVATE_KEY");
      const signature = await signer._signTypedData(domain, types, message);
      order.signature = signature;
      return order;
    }

    async function submitOrder(signedOrder) {
      const response = await fetch(orderBookApi, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(signedOrder)
      });
      const data = await response.json();
      if (data.status === "success") {
        console.log("订单提交成功");
      } else {
        console.error("订单提交失败", data);
      }
    }

    function startAutoQuote() {
      const intervalSeconds = parseInt(document.getElementById("refreshInterval").value, 10);
      if (autoInterval) clearInterval(autoInterval);
      getQuote();
      autoInterval = setInterval(getQuote, intervalSeconds * 1000);
      startAutoBtn.disabled = true;
      stopAutoBtn.disabled = false;
      outputEl.textContent = `已开始自动刷新报价，每 ${intervalSeconds} 秒更新一次。`;
    }

    function stopAutoQuote() {
      if (autoInterval) clearInterval(autoInterval);
      startAutoBtn.disabled = false;
      stopAutoBtn.disabled = true;
      outputEl.textContent = "已停止自动刷新。";
    }

    getQuoteBtn.addEventListener("click", getQuote);
    startAutoBtn.addEventListener("click", startAutoQuote);
    stopAutoBtn.addEventListener("click", stopAutoQuote);
  </script>
</body>
</html>
